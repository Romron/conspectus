**Циклы** (или **The Loop**) — одна из самых важных и базовых концепций в WordPress. Это механизм, который WordPress использует для вывода постов на страницу.

**The Loop** — это цикл, который проходит через записи, извлеченные из базы данных, и выводит их на экран. Это основа для отображения постов на любой странице WordPress, будь то блог, архив, категория или главная страница.


Стандартный цикл выглядит так:


```php
if ( have_posts() ) : while ( have_posts() ) : the_post(); 
	// Шаблон для отображения каждой записи

else : 
	// Шаблон для отображения, если записи не найдены
endif;
```

- **`have_posts()`**: проверяет, есть ли записи для отображения.
- **`the_post()`**: устанавливает данные текущей записи.
- Внутри цикла можно выводить различные элементы поста: заголовок, контент, метаинформацию.

### **WP_Query**

WP_Query — это класс в WordPress, который позволяет создавать и настраивать запросы к базе данных. Вместо того чтобы полагаться на стандартный цикл, WP_Query позволяет выводить кастомные списки постов, например, определенные категории или метки, или даже определенные посты на основании сложных критериев.

Пример использования WP_Query для кастомного цикла:

```php

$args = array( 'post_type' => 'post', 
			  'posts_per_page' => 5, 
			  'category_name' => 'news', 
			  ); 
$query = new WP_Query( $args );
if ( $query->have_posts() ) : 
	while ( $query->have_posts() ) : 
		$query->the_post(); 
		the_title(); 
		the_excerpt(); 
	endwhile; 
	wp_reset_postdata(); 
else : 
	echo 'Нет записей'; 
endif;
```

- **Аргументы запроса**: в массиве `$args` можно указывать параметры запроса, такие как тип поста, количество постов, категории, теги и т.д.
- **`wp_reset_postdata()`**: после завершения кастомного запроса важно восстановить глобальные переменные поста.

### **Работа с несколькими циклами**

Иногда может потребоваться несколько циклов на одной странице (например, отображение основных новостей и отдельно — последние статьи). 
Использование WP_Query позволяет гибко управлять выводом контента, но нужно помнить о правильном восстановлении глобального состояния постов через `wp_reset_postdata()`.

```php

// Первый цикл для одной категории 
$first_query = new WP_Query( 
	array( 
	'category_name' => 'news', 
	'posts_per_page' => 3 
	) ); 
	
	if ( $first_query->have_posts() ) : 
		while ( $first_query->have_posts() ) : 
			$first_query->the_post(); 
			the_title(); 
		endwhile; 
		wp_reset_postdata(); 
	endif; 
	
// Второй цикл для другой категории 
$second_query = new WP_Query( 
	array( 
		'category_name' => 'reviews', 
		'posts_per_page' => 3 
		) ); 
	if ( $second_query->have_posts() ) : 
		while ( $second_query->have_posts() ) : 
			$second_query->the_post(); 
			the_title(); 
		endwhile; 
		wp_reset_postdata(); 
	endif;

```

### **Циклы для кастомных типов записей (CPT)**

В WordPress можно создавать собственные типы записей (Custom Post Types), например, для портфолио, отзывов, продуктов и т.д. WP_Query также позволяет выводить данные для этих типов записей.

### **Модификация основного запроса (query_posts и pre_get_posts)**

Иногда может потребоваться изменить основной запрос WordPress (например, чтобы показывать посты только определенной категории на главной странице). Есть два подхода:

- **`query_posts()`**: этот метод модифицирует главный цикл WordPress, но его не рекомендуется использовать, так как он полностью заменяет оригинальный запрос.
- **`pre_get_posts`**: это более безопасный и гибкий способ изменить запрос.

Пример использования `pre_get_posts` для изменения главного запроса на главной странице:

```php
function modify_main_query( $query ) { 
	if ( $query->is_home() && $query->is_main_query() ) { 
		$query->set( 'post_type', 'portfolio' ); 
		$query->set( 'posts_per_page', 5 ); 
	} 
} 
add_action( 'pre_get_posts', 'modify_main_query' );
```

Этот код изменяет главный запрос только для главной страницы и выводит записи из кастомного типа записи "portfolio".

### **Оптимизация циклов**

При работе с большими объемами данных можно использовать различные техники оптимизации:

- **Кеширование запросов**: при сложных запросах полезно закешировать результаты, чтобы уменьшить нагрузку на базу данных.
- **[[Lazy Load]]**: подгрузка постов по мере прокрутки страницы.
- **[[Пагинация]]**: использование пагинации для разбиения длинных списков постов.

### **Специальные функции для работы с циклом**

- **`the_title()`**: выводит заголовок записи.
- **`the_content()`**: выводит контент записи.
- **`the_excerpt()`**: выводит краткое описание записи.
- **`the_post_thumbnail()`**: выводит миниатюру записи.
- **`the_permalink()`**: выводит ссылку на запись.